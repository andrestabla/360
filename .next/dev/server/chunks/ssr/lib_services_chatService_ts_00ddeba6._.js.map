{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/services/chatService.ts"],"sourcesContent":["import { DB, Conversation, ChatMessage, User, ConversationMember, Attachment } from '../data';\n\nexport interface ChatServiceResponse<T> {\n  success: boolean;\n  data: T;\n  error?: string;\n}\n\nexport const ChatService = {\n  getConversations: async (userId: string, tenantId: string): Promise<ChatServiceResponse<Conversation[]>> => {\n    const conversations = DB.conversations.filter(\n      c => c.tenant_id === tenantId && c.participants.includes(userId)\n    );\n    return { success: true, data: conversations };\n  },\n\n  getConversation: async (conversationId: string): Promise<ChatServiceResponse<Conversation | null>> => {\n    const conversation = DB.conversations.find(c => c.id === conversationId) || null;\n    return { success: true, data: conversation };\n  },\n\n  getMessages: async (conversationId: string, cursor?: string, limit: number = 50): Promise<ChatServiceResponse<ChatMessage[]> & { nextCursor?: string; hasMore: boolean }> => {\n    let messages = DB.messages.filter(m => m.conversation_id === conversationId);\n    messages.sort((a, b) => new Date(b.created_at).getTime() - new Date(a.created_at).getTime());\n    const hasMore = messages.length > limit;\n    if (hasMore) {\n      messages = messages.slice(0, limit);\n    }\n    return { success: true, data: messages.reverse(), hasMore, nextCursor: hasMore ? messages[0]?.id : undefined };\n  },\n\n  sendMessage: async (\n    conversationId: string,\n    senderId: string,\n    body: string,\n    tempId?: string,\n    replyToMessageId?: string,\n    attachments?: Attachment[]\n  ): Promise<ChatMessage> => {\n    const sender = DB.users.find(u => u.id === senderId);\n    const conversation = DB.conversations.find(c => c.id === conversationId);\n    \n    const message: ChatMessage = {\n      id: `msg-${Date.now()}`,\n      tenant_id: conversation?.tenant_id || '',\n      conversation_id: conversationId,\n      sender_id: senderId,\n      body,\n      body_type: 'text',\n      created_at: new Date().toISOString(),\n      senderName: sender?.name || 'Unknown',\n      reply_to_message_id: replyToMessageId,\n      attachments: attachments,\n      tempId,\n      status: 'sent'\n    };\n\n    DB.messages.push(message);\n\n    if (conversation) {\n      conversation.lastMessage = body;\n      conversation.lastMessageAt = message.created_at;\n    }\n\n    DB.save();\n    return message;\n  },\n\n  createConversation: async (\n    tenantId: string,\n    type: 'dm' | 'group',\n    participants: string[],\n    name?: string\n  ): Promise<ChatServiceResponse<Conversation>> => {\n    const conversation: Conversation = {\n      id: `conv-${Date.now()}`,\n      tenant_id: tenantId,\n      type,\n      name,\n      participants,\n      createdAt: new Date().toISOString(),\n      unreadCount: 0\n    };\n\n    DB.conversations.push(conversation);\n    DB.save();\n    return { success: true, data: conversation };\n  },\n\n  markAsRead: async (conversationId: string, userId: string): Promise<ChatServiceResponse<boolean>> => {\n    const conversation = DB.conversations.find(c => c.id === conversationId);\n    if (conversation) {\n      conversation.unreadCount = 0;\n    }\n    DB.save();\n    return { success: true, data: true };\n  },\n\n  getUsers: async (tenantId: string): Promise<ChatServiceResponse<User[]>> => {\n    const users = DB.users.filter(u => u.tenantId === tenantId && u.status === 'ACTIVE');\n    return { success: true, data: users };\n  },\n\n  checkNewMessages: async (userId: string, tenantId: string, since: string): Promise<ChatMessage[]> => {\n    const userConversations = DB.conversations.filter(\n      c => c.tenant_id === tenantId && c.participants.includes(userId)\n    );\n    const conversationIds = userConversations.map(c => c.id);\n    const newMessages = DB.messages.filter(\n      m => conversationIds.includes(m.conversation_id) && \n           m.sender_id !== userId &&\n           new Date(m.created_at) > new Date(since)\n    );\n    return newMessages;\n  },\n\n  searchMessages: async (tenantId: string, query: string, conversationId?: string): Promise<ChatMessage[]> => {\n    const lowerQuery = query.toLowerCase();\n    let messages = DB.messages.filter(m => m.tenant_id === tenantId);\n    if (conversationId) {\n      messages = messages.filter(m => m.conversation_id === conversationId);\n    }\n    return messages.filter(m => m.body.toLowerCase().includes(lowerQuery));\n  },\n\n  searchConversations: async (tenantId: string, userId: string, query: string): Promise<Conversation[]> => {\n    const lowerQuery = query.toLowerCase();\n    return DB.conversations.filter(\n      c => c.tenant_id === tenantId && \n           c.participants.includes(userId) &&\n           (c.name?.toLowerCase().includes(lowerQuery) || c.title?.toLowerCase().includes(lowerQuery))\n    );\n  },\n\n  searchUsers: async (tenantId: string, query: string): Promise<User[]> => {\n    const lowerQuery = query.toLowerCase();\n    return DB.users.filter(\n      u => u.tenantId === tenantId && \n           u.status === 'ACTIVE' &&\n           (u.name.toLowerCase().includes(lowerQuery) || u.email?.toLowerCase().includes(lowerQuery))\n    );\n  },\n\n  createDM: async (tenantId: string, userId1: string, userId2: string): Promise<ChatServiceResponse<Conversation>> => {\n    const existing = DB.conversations.find(\n      c => c.tenant_id === tenantId && c.type === 'dm' && \n           c.participants.includes(userId1) && c.participants.includes(userId2)\n    );\n    if (existing) return { success: true, data: existing };\n\n    const conversation: Conversation = {\n      id: `conv-${Date.now()}`,\n      tenant_id: tenantId,\n      type: 'dm',\n      participants: [userId1, userId2],\n      createdAt: new Date().toISOString()\n    };\n    DB.conversations.push(conversation);\n    DB.save();\n    return { success: true, data: conversation };\n  },\n\n  createGroup: async (tenantId: string, name: string, creatorId: string, memberIds: string[]): Promise<ChatServiceResponse<Conversation>> => {\n    const conversation: Conversation = {\n      id: `conv-${Date.now()}`,\n      tenant_id: tenantId,\n      type: 'group',\n      name,\n      title: name,\n      participants: [creatorId, ...memberIds],\n      createdAt: new Date().toISOString()\n    };\n    DB.conversations.push(conversation);\n    DB.save();\n    return { success: true, data: conversation };\n  },\n\n  isBlocked: async (userId: string, targetUserId: string): Promise<boolean> => {\n    return false;\n  },\n\n  blockUser: async (userId: string, targetUserId: string): Promise<boolean> => {\n    return true;\n  },\n\n  unblockUser: async (userId: string, targetUserId: string): Promise<boolean> => {\n    return true;\n  },\n\n  editMessage: async (messageId: string, userId: string, newBody: string): Promise<ChatServiceResponse<ChatMessage | null>> => {\n    const message = DB.messages.find(m => m.id === messageId && m.sender_id === userId);\n    if (message) {\n      message.body = newBody;\n      DB.save();\n      return { success: true, data: message };\n    }\n    return { success: false, data: null, error: 'Message not found' };\n  },\n\n  deleteMessage: async (messageId: string, userId: string): Promise<ChatServiceResponse<boolean>> => {\n    const idx = DB.messages.findIndex(m => m.id === messageId && m.sender_id === userId);\n    if (idx > -1) {\n      DB.messages.splice(idx, 1);\n      DB.save();\n      return { success: true, data: true };\n    }\n    return { success: false, data: false, error: 'Message not found' };\n  },\n\n  toggleReaction: async (messageId: string, userId: string, reaction: string): Promise<ChatServiceResponse<boolean>> => {\n    return { success: true, data: true };\n  },\n\n  uploadFile: async (file: File, tenantId: string, onProgress?: (percent: number) => void): Promise<Attachment> => {\n    if (onProgress) onProgress(100);\n    return {\n      id: `att-${Date.now()}`,\n      url: URL.createObjectURL(file),\n      name: file.name,\n      file_name: file.name,\n      size: file.size,\n      type: file.type,\n      mime_type: file.type,\n      tenant_id: tenantId,\n      created_at: new Date().toISOString()\n    };\n  },\n\n  leaveGroup: async (conversationId: string, userId: string): Promise<ChatServiceResponse<boolean>> => {\n    const conv = DB.conversations.find(c => c.id === conversationId);\n    if (conv) {\n      conv.participants = conv.participants.filter(p => p !== userId);\n      DB.save();\n      return { success: true, data: true };\n    }\n    return { success: false, data: false };\n  },\n\n  muteConversation: async (conversationId: string, userId: string, until: string): Promise<ChatServiceResponse<boolean>> => {\n    return { success: true, data: true };\n  },\n\n  getNotificationSettings: async (conversationId: string, userId: string): Promise<{ level: string; mutedUntil?: string }> => {\n    return { level: 'all' };\n  },\n\n  updateNotificationSettings: async (conversationId: string, userId: string, level: string): Promise<boolean> => {\n    return true;\n  },\n\n  getGroupMembers: async (conversationId: string): Promise<User[]> => {\n    const conv = DB.conversations.find(c => c.id === conversationId);\n    if (!conv) return [];\n    return DB.users.filter(u => conv.participants.includes(u.id));\n  },\n\n  reportContent: async (userId: string, tenantId: string, report: { targetId: string; type: string; reason: string; detail: string }): Promise<ChatServiceResponse<boolean>> => {\n    return { success: true, data: true };\n  }\n};\n"],"names":[],"mappings":"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"}}]
}