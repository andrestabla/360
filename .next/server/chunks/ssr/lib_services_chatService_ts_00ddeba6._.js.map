{"version":3,"sources":["../../../../lib/services/chatService.ts"],"sourcesContent":["import { DB, Conversation, ChatMessage, User, ConversationMember, Attachment } from '../data';\n\nexport interface ChatServiceResponse<T> {\n  success: boolean;\n  data: T;\n  error?: string;\n}\n\nexport const ChatService = {\n  getConversations: async (userId: string, tenantId: string): Promise<ChatServiceResponse<Conversation[]>> => {\n    const conversations = DB.conversations.filter(\n      c => c.tenant_id === tenantId && c.participants.includes(userId)\n    );\n    return { success: true, data: conversations };\n  },\n\n  getConversation: async (conversationId: string): Promise<ChatServiceResponse<Conversation | null>> => {\n    const conversation = DB.conversations.find(c => c.id === conversationId) || null;\n    return { success: true, data: conversation };\n  },\n\n  getMessages: async (conversationId: string, cursor?: string, limit: number = 50): Promise<ChatServiceResponse<ChatMessage[]> & { nextCursor?: string; hasMore: boolean }> => {\n    let messages = DB.messages.filter(m => m.conversation_id === conversationId);\n    messages.sort((a, b) => new Date(b.created_at).getTime() - new Date(a.created_at).getTime());\n    const hasMore = messages.length > limit;\n    if (hasMore) {\n      messages = messages.slice(0, limit);\n    }\n    return { success: true, data: messages.reverse(), hasMore, nextCursor: hasMore ? messages[0]?.id : undefined };\n  },\n\n  sendMessage: async (\n    conversationId: string,\n    senderId: string,\n    body: string,\n    tempId?: string,\n    replyToMessageId?: string,\n    attachments?: Attachment[]\n  ): Promise<ChatMessage> => {\n    const sender = DB.users.find(u => u.id === senderId);\n    const conversation = DB.conversations.find(c => c.id === conversationId);\n    \n    const message: ChatMessage = {\n      id: `msg-${Date.now()}`,\n      tenant_id: conversation?.tenant_id || '',\n      conversation_id: conversationId,\n      sender_id: senderId,\n      body,\n      body_type: 'text',\n      created_at: new Date().toISOString(),\n      senderName: sender?.name || 'Unknown',\n      reply_to_message_id: replyToMessageId,\n      attachments: attachments,\n      tempId,\n      status: 'sent'\n    };\n\n    DB.messages.push(message);\n\n    if (conversation) {\n      conversation.lastMessage = body;\n      conversation.lastMessageAt = message.created_at;\n    }\n\n    DB.save();\n    return message;\n  },\n\n  createConversation: async (\n    tenantId: string,\n    type: 'dm' | 'group',\n    participants: string[],\n    name?: string\n  ): Promise<ChatServiceResponse<Conversation>> => {\n    const conversation: Conversation = {\n      id: `conv-${Date.now()}`,\n      tenant_id: tenantId,\n      type,\n      name,\n      participants,\n      createdAt: new Date().toISOString(),\n      unreadCount: 0\n    };\n\n    DB.conversations.push(conversation);\n    DB.save();\n    return { success: true, data: conversation };\n  },\n\n  markAsRead: async (conversationId: string, userId: string): Promise<ChatServiceResponse<boolean>> => {\n    const conversation = DB.conversations.find(c => c.id === conversationId);\n    if (conversation) {\n      conversation.unreadCount = 0;\n    }\n    DB.save();\n    return { success: true, data: true };\n  },\n\n  getUsers: async (tenantId: string): Promise<ChatServiceResponse<User[]>> => {\n    const users = DB.users.filter(u => u.tenantId === tenantId && u.status === 'ACTIVE');\n    return { success: true, data: users };\n  },\n\n  checkNewMessages: async (userId: string, tenantId: string, since: string): Promise<ChatMessage[]> => {\n    const userConversations = DB.conversations.filter(\n      c => c.tenant_id === tenantId && c.participants.includes(userId)\n    );\n    const conversationIds = userConversations.map(c => c.id);\n    const newMessages = DB.messages.filter(\n      m => conversationIds.includes(m.conversation_id) && \n           m.sender_id !== userId &&\n           new Date(m.created_at) > new Date(since)\n    );\n    return newMessages;\n  },\n\n  searchMessages: async (tenantId: string, query: string, conversationId?: string): Promise<ChatMessage[]> => {\n    const lowerQuery = query.toLowerCase();\n    let messages = DB.messages.filter(m => m.tenant_id === tenantId);\n    if (conversationId) {\n      messages = messages.filter(m => m.conversation_id === conversationId);\n    }\n    return messages.filter(m => m.body.toLowerCase().includes(lowerQuery));\n  },\n\n  searchConversations: async (tenantId: string, userId: string, query: string): Promise<Conversation[]> => {\n    const lowerQuery = query.toLowerCase();\n    return DB.conversations.filter(\n      c => c.tenant_id === tenantId && \n           c.participants.includes(userId) &&\n           (c.name?.toLowerCase().includes(lowerQuery) || c.title?.toLowerCase().includes(lowerQuery))\n    );\n  },\n\n  searchUsers: async (tenantId: string, query: string): Promise<User[]> => {\n    const lowerQuery = query.toLowerCase();\n    return DB.users.filter(\n      u => u.tenantId === tenantId && \n           u.status === 'ACTIVE' &&\n           (u.name.toLowerCase().includes(lowerQuery) || u.email?.toLowerCase().includes(lowerQuery))\n    );\n  },\n\n  createDM: async (tenantId: string, userId1: string, userId2: string): Promise<ChatServiceResponse<Conversation>> => {\n    const existing = DB.conversations.find(\n      c => c.tenant_id === tenantId && c.type === 'dm' && \n           c.participants.includes(userId1) && c.participants.includes(userId2)\n    );\n    if (existing) return { success: true, data: existing };\n\n    const conversation: Conversation = {\n      id: `conv-${Date.now()}`,\n      tenant_id: tenantId,\n      type: 'dm',\n      participants: [userId1, userId2],\n      createdAt: new Date().toISOString()\n    };\n    DB.conversations.push(conversation);\n    DB.save();\n    return { success: true, data: conversation };\n  },\n\n  createGroup: async (tenantId: string, name: string, creatorId: string, memberIds: string[]): Promise<ChatServiceResponse<Conversation>> => {\n    const conversation: Conversation = {\n      id: `conv-${Date.now()}`,\n      tenant_id: tenantId,\n      type: 'group',\n      name,\n      title: name,\n      participants: [creatorId, ...memberIds],\n      createdAt: new Date().toISOString()\n    };\n    DB.conversations.push(conversation);\n    DB.save();\n    return { success: true, data: conversation };\n  },\n\n  isBlocked: async (userId: string, targetUserId: string): Promise<boolean> => {\n    return false;\n  },\n\n  blockUser: async (userId: string, targetUserId: string): Promise<boolean> => {\n    return true;\n  },\n\n  unblockUser: async (userId: string, targetUserId: string): Promise<boolean> => {\n    return true;\n  },\n\n  editMessage: async (messageId: string, userId: string, newBody: string): Promise<ChatServiceResponse<ChatMessage | null>> => {\n    const message = DB.messages.find(m => m.id === messageId && m.sender_id === userId);\n    if (message) {\n      message.body = newBody;\n      DB.save();\n      return { success: true, data: message };\n    }\n    return { success: false, data: null, error: 'Message not found' };\n  },\n\n  deleteMessage: async (messageId: string, userId: string): Promise<ChatServiceResponse<boolean>> => {\n    const idx = DB.messages.findIndex(m => m.id === messageId && m.sender_id === userId);\n    if (idx > -1) {\n      DB.messages.splice(idx, 1);\n      DB.save();\n      return { success: true, data: true };\n    }\n    return { success: false, data: false, error: 'Message not found' };\n  },\n\n  toggleReaction: async (messageId: string, userId: string, reaction: string): Promise<ChatServiceResponse<boolean>> => {\n    return { success: true, data: true };\n  },\n\n  uploadFile: async (file: File, tenantId: string, onProgress?: (percent: number) => void): Promise<Attachment> => {\n    if (onProgress) onProgress(100);\n    return {\n      id: `att-${Date.now()}`,\n      url: URL.createObjectURL(file),\n      name: file.name,\n      file_name: file.name,\n      size: file.size,\n      type: file.type,\n      mime_type: file.type,\n      tenant_id: tenantId,\n      created_at: new Date().toISOString()\n    };\n  },\n\n  leaveGroup: async (conversationId: string, userId: string): Promise<ChatServiceResponse<boolean>> => {\n    const conv = DB.conversations.find(c => c.id === conversationId);\n    if (conv) {\n      conv.participants = conv.participants.filter(p => p !== userId);\n      DB.save();\n      return { success: true, data: true };\n    }\n    return { success: false, data: false };\n  },\n\n  muteConversation: async (conversationId: string, userId: string, until: string): Promise<ChatServiceResponse<boolean>> => {\n    return { success: true, data: true };\n  },\n\n  getNotificationSettings: async (conversationId: string, userId: string): Promise<{ level: string; mutedUntil?: string }> => {\n    return { level: 'all' };\n  },\n\n  updateNotificationSettings: async (conversationId: string, userId: string, level: string): Promise<boolean> => {\n    return true;\n  },\n\n  getGroupMembers: async (conversationId: string): Promise<User[]> => {\n    const conv = DB.conversations.find(c => c.id === conversationId);\n    if (!conv) return [];\n    return DB.users.filter(u => conv.participants.includes(u.id));\n  },\n\n  reportContent: async (userId: string, tenantId: string, report: { targetId: string; type: string; reason: string; detail: string }): Promise<ChatServiceResponse<boolean>> => {\n    return { success: true, data: true };\n  }\n};\n"],"names":[],"mappings":"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"}