{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 16, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/lib/services/sessionToken.edge.ts"],"sourcesContent":["export interface SessionPayload {\n  email: string;\n  isSuperAdmin: boolean;\n  tenantId?: string;\n  tenantSlug?: string;\n  timestamp: number;\n}\n\nfunction getSessionSecret(): string {\n  const secret = process.env.SESSION_SECRET || process.env.EMAIL_ENCRYPTION_KEY;\n  if (!secret) {\n    return 'dev-secret-key-do-not-use-in-production';\n  }\n  return secret;\n}\n\nasync function hmacSign(data: string, secret: string): Promise<string> {\n  const encoder = new TextEncoder();\n  const key = await crypto.subtle.importKey(\n    'raw',\n    encoder.encode(secret),\n    { name: 'HMAC', hash: 'SHA-256' },\n    false,\n    ['sign']\n  );\n  const signature = await crypto.subtle.sign('HMAC', key, encoder.encode(data));\n  return Array.from(new Uint8Array(signature))\n    .map(b => b.toString(16).padStart(2, '0'))\n    .join('');\n}\n\nexport async function verifySessionTokenEdge(token: string): Promise<SessionPayload | null> {\n  try {\n    const [payloadBase64, signature] = token.split('.');\n    \n    if (!payloadBase64 || !signature) {\n      return null;\n    }\n\n    const secret = getSessionSecret();\n    const expectedSignature = await hmacSign(payloadBase64, secret);\n    \n    if (signature !== expectedSignature) {\n      return null;\n    }\n\n    const decoded = atob(payloadBase64);\n    const payload = JSON.parse(decoded) as SessionPayload;\n    \n    const sessionAge = Date.now() - payload.timestamp;\n    const MAX_SESSION_AGE = 24 * 60 * 60 * 1000;\n    if (sessionAge > MAX_SESSION_AGE) {\n      return null;\n    }\n\n    return payload;\n  } catch {\n    return null;\n  }\n}\n"],"names":[],"mappings":";;;;AAQA,SAAS;IACP,MAAM,SAAS,QAAQ,GAAG,CAAC,cAAc,IAAI,QAAQ,GAAG,CAAC,oBAAoB;IAC7E,IAAI,CAAC,QAAQ;QACX,OAAO;IACT;IACA,OAAO;AACT;AAEA,eAAe,SAAS,IAAY,EAAE,MAAc;IAClD,MAAM,UAAU,IAAI;IACpB,MAAM,MAAM,MAAM,OAAO,MAAM,CAAC,SAAS,CACvC,OACA,QAAQ,MAAM,CAAC,SACf;QAAE,MAAM;QAAQ,MAAM;IAAU,GAChC,OACA;QAAC;KAAO;IAEV,MAAM,YAAY,MAAM,OAAO,MAAM,CAAC,IAAI,CAAC,QAAQ,KAAK,QAAQ,MAAM,CAAC;IACvE,OAAO,MAAM,IAAI,CAAC,IAAI,WAAW,YAC9B,GAAG,CAAC,CAAA,IAAK,EAAE,QAAQ,CAAC,IAAI,QAAQ,CAAC,GAAG,MACpC,IAAI,CAAC;AACV;AAEO,eAAe,uBAAuB,KAAa;IACxD,IAAI;QACF,MAAM,CAAC,eAAe,UAAU,GAAG,MAAM,KAAK,CAAC;QAE/C,IAAI,CAAC,iBAAiB,CAAC,WAAW;YAChC,OAAO;QACT;QAEA,MAAM,SAAS;QACf,MAAM,oBAAoB,MAAM,SAAS,eAAe;QAExD,IAAI,cAAc,mBAAmB;YACnC,OAAO;QACT;QAEA,MAAM,UAAU,KAAK;QACrB,MAAM,UAAU,KAAK,KAAK,CAAC;QAE3B,MAAM,aAAa,KAAK,GAAG,KAAK,QAAQ,SAAS;QACjD,MAAM,kBAAkB,KAAK,KAAK,KAAK;QACvC,IAAI,aAAa,iBAAiB;YAChC,OAAO;QACT;QAEA,OAAO;IACT,EAAE,OAAM;QACN,OAAO;IACT;AACF"}},
    {"offset": {"line": 65, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/middleware.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport type { NextRequest } from 'next/server';\nimport { verifySessionTokenEdge } from '@/lib/services/sessionToken.edge';\n\nconst PUBLIC_PATHS = [\n  '/',\n  '/features',\n  '/pricing',\n  '/login',\n  '/api/tenants',\n  '/api/auth',\n  '/api/health',\n];\n\nconst PUBLIC_PATH_PREFIXES = [\n  '/_next',\n  '/static',\n  '/favicon',\n  '/api/tenants/',\n];\n\nconst AUTH_PATHS = ['/login', '/auth'];\n\nconst PROTECTED_PATH_PREFIXES = ['/dashboard', '/admin'];\n\nconst SUPER_ADMIN_PATHS = ['/admin'];\n\nfunction isPublicPath(pathname: string): boolean {\n  if (PUBLIC_PATHS.includes(pathname)) return true;\n  if (PUBLIC_PATH_PREFIXES.some(prefix => pathname.startsWith(prefix))) return true;\n  if (pathname.match(/^\\/(demo|alpha|beta|[a-z0-9-]+)$/)) return true;\n  return false;\n}\n\nfunction isAuthPath(pathname: string): boolean {\n  return AUTH_PATHS.some(path => pathname.includes(path));\n}\n\nfunction isProtectedPath(pathname: string): boolean {\n  return PROTECTED_PATH_PREFIXES.some(prefix => pathname.startsWith(prefix));\n}\n\nfunction isSuperAdminPath(pathname: string): boolean {\n  return SUPER_ADMIN_PATHS.some(prefix => pathname.startsWith(prefix));\n}\n\nfunction extractTenantSlug(pathname: string): string | null {\n  const match = pathname.match(/^\\/([a-z0-9-]+)\\//);\n  if (match && !['dashboard', 'admin', 'api', '_next', 'static', 'features', 'pricing', 'login', 'auth'].includes(match[1])) {\n    return match[1];\n  }\n  return null;\n}\n\nexport async function middleware(request: NextRequest) {\n  const { pathname } = request.nextUrl;\n  const host = request.headers.get('host') || '';\n  \n  const response = NextResponse.next();\n  \n  const tenantSlug = extractTenantSlug(pathname);\n  if (tenantSlug) {\n    response.headers.set('x-tenant-slug', tenantSlug);\n  }\n  \n  const isMainDomain = host.includes('maturity.online') || host.includes('localhost') || host.includes('replit');\n  response.headers.set('x-is-main-domain', isMainDomain ? 'true' : 'false');\n  \n  if (isPublicPath(pathname)) {\n    return response;\n  }\n  \n  if (pathname.startsWith('/api/')) {\n    const authHeader = request.headers.get('authorization');\n    if (authHeader?.startsWith('Bearer ')) {\n      const token = authHeader.substring(7);\n      const payload = await verifySessionTokenEdge(token);\n      \n      if (payload) {\n        response.headers.set('x-user-email', payload.email);\n        response.headers.set('x-is-super-admin', payload.isSuperAdmin ? 'true' : 'false');\n        if (payload.tenantId) {\n          response.headers.set('x-tenant-id', payload.tenantId);\n        }\n      }\n    }\n    return response;\n  }\n  \n  if (!isProtectedPath(pathname)) {\n    return response;\n  }\n  \n  const sessionCookie = request.cookies.get('m360_session');\n  const token = sessionCookie?.value;\n  \n  if (!token) {\n    const loginUrl = new URL('/login', request.url);\n    loginUrl.searchParams.set('redirect', pathname);\n    return NextResponse.redirect(loginUrl);\n  }\n  \n  const payload = await verifySessionTokenEdge(token);\n  \n  if (!payload) {\n    const loginUrl = new URL('/login', request.url);\n    loginUrl.searchParams.set('redirect', pathname);\n    loginUrl.searchParams.set('reason', 'session_expired');\n    const redirectResponse = NextResponse.redirect(loginUrl);\n    redirectResponse.cookies.delete('m360_session');\n    return redirectResponse;\n  }\n  \n  if (isSuperAdminPath(pathname) && !payload.isSuperAdmin) {\n    return NextResponse.redirect(new URL('/dashboard', request.url));\n  }\n  \n  response.headers.set('x-user-email', payload.email);\n  response.headers.set('x-is-super-admin', payload.isSuperAdmin ? 'true' : 'false');\n  if (payload.tenantId) {\n    response.headers.set('x-tenant-id', payload.tenantId);\n  }\n  if (payload.tenantSlug) {\n    response.headers.set('x-tenant-slug', payload.tenantSlug);\n  }\n  \n  return response;\n}\n\nexport const config = {\n  matcher: [\n    '/((?!_next/static|_next/image|favicon.ico|.*\\\\.(?:svg|png|jpg|jpeg|gif|webp|ico|css|js|woff|woff2|ttf|eot)$).*)',\n  ],\n};\n"],"names":[],"mappings":"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"}}]
}